# Contributing to Memory Bench

Thank you for your interest in contributing to Memory Bench! This document provides guidelines and information for developers.

## 🏗️ Development Setup

### Prerequisites

1. **Node.js**: Version 20 or higher
2. **Ollama**: For local embeddings
3. **FFmpeg**: For image comparison
4. **OpenRouter API Key**: For AI vision capabilities

### Initial Setup

```bash
# Clone the repository
git clone <repository-url>
cd memory-bench

# Install dependencies
npm install

# Create environment file
cp env.template .env
# Edit .env and add your OPENROUTER_API_KEY

# Pull required Ollama model
ollama pull embeddinggemma:latest

# Build and run
npm start
```

## 📂 Project Architecture

### Source Files (`src/`)

- **electron-main.ts**: Main Electron process
  - Window management
  - Screenshot capture loop
  - IPC handlers
  - System tray integration
  
- **renderer.ts**: Renderer process (UI)
  - Chat interface logic
  - User input handling
  - Message display
  - Click-through behavior

- **preload.js**: IPC bridge
  - Secure communication between main and renderer
  - Exposed API to renderer

- **model.ts**: OpenRouter integration
  - API client initialization
  - Image and text chat functions
  - Error handling and retries

- **embeddings.ts**: Vector embeddings and RAG
  - Ollama integration
  - Cosine similarity calculation
  - Top-K retrieval

- **prompts.ts**: Centralized AI prompts
  - Screenshot description prompt
  - Question answering prompt
  - Prompt generation functions

- **index.ts**: Terminal version
  - Alternative CLI interface
  - Concurrent capture and Q&A loops

### Build Output (`dist/`)

- Auto-generated by TypeScript compiler
- **Never edit files in `dist/` directly**
- Regenerated on each build

## 🔧 Development Workflow

### Building

```bash
# Clean build
npm run clean
npm run build

# Build and run
npm run dev
```

### Code Style

- Use TypeScript for all new code
- Follow existing naming conventions
- Add JSDoc comments for public functions
- Use `async/await` for asynchronous operations

### File Organization

```
✅ DO: Edit files in src/
✅ DO: Keep prompts in prompts.ts
✅ DO: Update config.yml for settings
❌ DON'T: Edit files in dist/
❌ DON'T: Hardcode prompts in code
❌ DON'T: Store credentials in code
```

## 🐛 Debugging

### Enable Debug Mode

```bash
DEBUG=true npm start
```

This enables:
- Verbose logging
- Error stack traces
- API request/response details

### Common Issues

**EPIPE Errors**: The app uses `safeLog()` and `safeError()` to prevent crashes from console errors.

**IPC Communication**: Check browser console and terminal output for both sides of the communication.

**Screenshot Capture**: Ensure FFmpeg is installed and `tmp/` directory exists.

## 🧪 Testing

### Manual Testing Checklist

- [ ] Screenshots capture every 3 seconds
- [ ] Memory counter updates in UI
- [ ] Duplicate screenshots are detected and skipped
- [ ] Questions return relevant answers
- [ ] UI shows thinking indicator during processing
- [ ] Memory info displays correctly
- [ ] Keyboard shortcuts work (ESC, Cmd/Ctrl+Q)
- [ ] Tray icon menu works
- [ ] Click-through behavior works correctly

### Testing API Integration

Create a test script:

```javascript
import { chatWithImage } from './dist/model.js';

const imagePath = './tmp/test_screenshot.png';
const response = await chatWithImage(
  'Describe this image',
  imagePath
);
console.log(response);
```

## 📝 Adding New Features

### Adding a New Prompt

1. Add the prompt to `src/prompts.ts`:
   ```typescript
   export const NEW_PROMPT = 'Your prompt here';
   ```

2. Import in the file where it's used:
   ```typescript
   import { NEW_PROMPT } from './prompts.js';
   ```

3. Use the imported constant instead of hardcoding

### Adding a New Configuration Option

1. Add to `config.yml`:
   ```yaml
   your_section:
     your_option: value
   ```

2. Document the option with a comment
3. Update README.md if user-facing

### Adding a New IPC Handler

1. In `electron-main.ts`:
   ```typescript
   ipcMain.handle('your-handler', async (event, arg) => {
     // Your logic here
     return result;
   });
   ```

2. In `preload.js`:
   ```javascript
   yourHandler: (arg) => ipcRenderer.invoke('your-handler', arg)
   ```

3. In `renderer.ts`:
   ```typescript
   const result = await window.electronAPI.yourHandler(arg);
   ```

## 🔒 Security Considerations

- Never commit `.env` file
- API keys should always be in environment variables
- Use `contextIsolation: true` in Electron
- Validate all user input before processing
- Use `safeLog()` to prevent console injection

## 📊 Performance Optimization

### Screenshot Capture

- Current interval: 3 seconds (configurable in `config.yml`)
- Duplicate detection prevents unnecessary processing
- Parallel processing: capture continues while AI processes

### Rate Limiting

- 1 second delay before each AI request
- Automatic retries with backoff
- Configurable in `config.yml`

### Memory Management

- Screenshots stored in `tmp/` directory
- Consider implementing cleanup for old screenshots
- Monitor memory array size for long-running sessions

## 🚀 Release Process

1. Update version in `package.json`
2. Update version in `config.yml`
3. Update CHANGELOG (if exists)
4. Run full build: `npm run clean && npm run build`
5. Test all features manually
6. Create git tag: `git tag v1.x.x`
7. Push with tags: `git push --tags`

## 📋 Code Review Checklist

- [ ] Code follows existing style and conventions
- [ ] TypeScript types are properly defined
- [ ] Error handling is implemented
- [ ] Console logs use `safeLog()` / `safeError()`
- [ ] No hardcoded credentials or API keys
- [ ] Prompts are centralized in `prompts.ts`
- [ ] Config options use `config.yml`
- [ ] Documentation is updated if needed
- [ ] No files edited in `dist/`
- [ ] Build completes without errors

## 🆘 Getting Help

### Logs to Check

1. **Terminal Output**: Main process logs
2. **Browser Console**: Renderer process logs (DevTools)
3. **Electron DevTools**: Open with `mainWindow.webContents.openDevTools()`

### Useful Commands

```bash
# Check if Ollama is running
ollama list

# Test FFmpeg
ffmpeg -version

# Check API key is set
cat .env

# View build errors
npm run build 2>&1 | grep error

# Check for TypeScript errors
npx tsc --noEmit
```

## 🤝 Pull Request Process

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/your-feature`
3. Make your changes following the guidelines above
4. Test thoroughly
5. Commit with descriptive messages
6. Push to your fork
7. Create a Pull Request with description of changes

## 💬 Questions?

If you have questions about contributing:

1. Check this guide first
2. Look at existing code for examples
3. Check console output for errors
4. Review README.md for usage information
5. Open an issue for discussion

---

Thank you for contributing to Memory Bench! 🎉

